<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Item Directory</title>

<style>
:root{
  --bg:#0b0f14;
  --text:#e6edf3;
  --muted:#9fb0c0;
  --border:#223042;
  --accent:#7aa2ff;
  --ok:#46d39a;
  --shadow:0 12px 40px rgba(0,0,0,.35);
  --radius:14px;
  --mono:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  --sans:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

  /* Map sizing */
  --tile: 42px;  /* size of each A–X tile */
  --gap: 8px;
}
*{box-sizing:border-box}
body{ margin:0; padding:18px; background:var(--bg); color:var(--text); font-family:var(--sans); }

header{
  max-width:1200px; margin:0 auto 16px;
  display:flex; justify-content:space-between; align-items:flex-end;
  gap:12px; flex-wrap:wrap;
}
h1{margin:0;font-size:18px}
.sub{color:var(--muted);font-size:12px}

.controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
input[type="text"]{
  min-width:280px; width:min(560px, 88vw);
  padding:10px 12px; border-radius:12px;
  border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);
  outline:none;
}
input[type="text"]:focus{
  border-color:rgba(122,162,255,.6);
  box-shadow:0 0 0 3px rgba(122,162,255,.15);
}
button{
  padding:10px 12px; border-radius:12px;
  border:1px solid var(--border); background:rgba(255,255,255,.04);
  color:var(--text); cursor:pointer; font-weight:700;
}
button:hover{background:rgba(255,255,255,.06)}

main{
  max-width:1200px; margin:0 auto;
  display:grid; grid-template-columns: 1fr 420px; gap:14px;
}
@media(max-width:980px){ main{ grid-template-columns: 1fr; } }

.panel{
  border:1px solid var(--border); border-radius:var(--radius);
  background:linear-gradient(to bottom, rgba(16,24,38,.78), rgba(16,24,38,.55));
  box-shadow:var(--shadow);
  overflow:hidden;
}
.hd{
  padding:12px 14px; border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
}
.k{ color:var(--muted); font-size:12px; letter-spacing:.35px; text-transform:uppercase; }
.bd{
  padding:12px 14px;
  overflow:auto; /* prevents clipping: scroll instead */
}
.mono{ font-family:var(--mono); }
.muted{ color:var(--muted); }

.notice{
  border:1px solid rgba(122,162,255,.35);
  background:rgba(122,162,255,.08);
  padding:10px 12px; border-radius:12px;
  font-size:12px; margin-bottom:10px;
}
.error{
  border:1px solid rgba(255,107,107,.35);
  background:rgba(255,107,107,.08);
  padding:10px 12px; border-radius:12px;
  font-size:12px; white-space:pre-line; margin-bottom:10px;
}

/* TABLE DIRECTORY */
.tableWrap{
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  background:rgba(255,255,255,.02);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:12.5px;
}
thead th{
  text-align:left;
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  color:var(--muted);
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.35px;
  user-select:none;
  cursor:pointer;
  position:sticky;
  top:0;
  background:rgba(16,24,38,.95);
}
thead th:hover{ color:var(--text); }
tbody td{
  padding:10px 10px;
  border-bottom:1px solid rgba(34,48,66,.6);
  vertical-align:top;
}
tbody tr{ cursor:pointer; }
tbody tr:hover{ background:rgba(255,255,255,.04); }
tbody tr.selected{ background:rgba(122,162,255,.10); }

.small{ font-size:11px; color:var(--muted); }
.pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(70,211,154,.35);
  color:var(--ok);
  background:rgba(70,211,154,.08);
  font-family:var(--mono);
  font-size:11px;
  white-space:nowrap;
}

/* Mobile: make map collapsible via <details> */
.mobileMap summary{
  cursor:pointer;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:12px;
  background:rgba(255,255,255,.03);
  margin-bottom:10px;
  list-style:none;
  user-select:none;
}
.mobileMap summary::-webkit-details-marker{ display:none; }
.mobileMap summary::after{
  content:"▼";
  float:right;
  color:var(--muted);
}
.mobileMap[open] summary::after{ content:"▲"; }

@media (min-width: 701px){
  .mobileMap summary{ display:none; }
  .mobileMap{ margin:0; }
}

/* MAP (enter from north): EAST left, SOUTH top, WEST right */
.mapGrid{
  display:grid;
  width:100%;
  max-width:100%;
  grid-template-columns: minmax(160px, 1fr) 18px minmax(160px, 1fr);
  grid-template-rows: auto 12px minmax(260px, 1fr);
  gap:10px;
  align-items:stretch;
  justify-content:center;
}
.wallBox{
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  background:rgba(255,255,255,.02);
}
.wallHd{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  gap:10px;
}
.wallName{ font-weight:900; }
.wallRange{ font-family:var(--mono); font-size:12px; color:var(--muted); }

/* Fixed tile sizing so every letter slot is identical */
.cols{
  display:grid;
  gap: var(--gap);
  padding:10px;
}
.cols.row{
  grid-auto-flow:column;
  grid-auto-columns: var(--tile);
  justify-content:center;
}
.cols.col{
  grid-auto-rows: var(--tile);
  justify-content:center;
}
.colTile{
  width: var(--tile);
  height: var(--tile);
  display:flex;
  align-items:center;
  justify-content:center;

  border:1px solid var(--border);
  border-radius:12px;
  font-family:var(--mono);
  font-weight:900;
  color:var(--muted);
  position:relative;
  user-select:none;
}
.colTile.has::after{
  content:"";
  position:absolute;
  top:6px; right:6px;
  width:7px; height:7px;
  border-radius:50%;
  background:var(--ok);
}
.colTile.active{
  color:var(--text);
  background:rgba(122,162,255,.12);
  border-color:rgba(122,162,255,.9);
  box-shadow:0 0 0 4px rgba(122,162,255,.18);
}

.centerGap{ grid-column:2; grid-row:2 / span 2; }
.centerLabel{
  writing-mode:vertical-rl;
  transform:rotate(180deg);
  color:var(--muted);
  font-size:11px;
  letter-spacing:.35px;
  text-transform:uppercase;
  text-align:center;
  user-select:none;
}

/* selection details */
.details{
  border-top:1px solid var(--border);
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

/* Responsive map scaling */
@media (max-width: 1100px){ :root{ --tile: 38px; } }
@media (max-width: 980px){  :root{ --tile: 36px; } }
@media (max-width: 520px){  :root{ --tile: 32px; } }
</style>
</head>

<body>
<header>
  <div>
    <h1>Item Directory</h1>
    <div class="sub">Search → sort → click an item to highlight its wall column</div>
  </div>
  <div class="controls">
    <input id="search" type="text" placeholder="Search (e.g. quartz, prismarine, ladders, G1-5)" />
    <button id="clear">Clear</button>
  </div>
</header>

<main>
  <!-- DIRECTORY -->
  <section class="panel">
    <div class="hd">
      <div class="k">Directory</div>
      <div class="mono muted" id="stat">Loading…</div>
    </div>
    <div class="bd">
      <div id="message" style="display:none;"></div>

      <!-- Local fallback only shown if server load fails -->
      <div id="localFallback" style="display:none;">
        <div class="notice">
          Server load failed (likely local file mode). Select <span class="mono">items.csv</span> from disk.
        </div>
        <input id="file" type="file" accept=".csv,text/csv" />
        <button id="loadFile">Load CSV</button>
        <div class="small" style="margin-top:8px;">
          On GitHub Pages this stays hidden and loads <span class="mono">items.csv</span> automatically.
        </div>
        <div style="height:12px;"></div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th data-sort="Description">Item</th>
              <th data-sort="ChestID">Location</th>
              <th data-sort="Categories">Category</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="muted" id="none" style="display:none;font-size:12px;margin-top:10px;">No matches.</div>
    </div>
  </section>

  <!-- MAP -->
  <section class="panel">
    <div class="hd">
      <div class="k">Barn Map</div>
      <div class="mono muted">Enter from North: East ← · South ↑ · West →</div>
    </div>
    <div class="bd">
      <div class="small muted" style="margin-bottom:10px;">
        East wall = A–I, South wall = J–O, West wall = P–X
      </div>

      <!-- Collapsible on mobile; always open on desktop -->
      <details class="mobileMap" open>
        <summary>Show barn map</summary>
        <div class="mapGrid" id="map"></div>
      </details>
    </div>

    <div class="details">
      <div>
        <div class="k">Item</div>
        <div class="mono" id="selDesc">—</div>
      </div>
      <div>
        <div class="k">Chest</div>
        <div class="mono" id="selChest">—</div>
      </div>
      <div>
        <div class="k">Column</div>
        <div class="mono" id="selCol">—</div>
      </div>
    </div>
  </section>
</main>

<script>
const $ = id => document.getElementById(id);

/* ---------------- CSV ---------------- */
function parseCSV(text){
  const rows=[]; let row=[], cur="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(q){
      if(c === '"' && n === '"'){ cur+='"'; i++; }
      else if(c === '"'){ q=false; }
      else cur+=c;
    } else {
      if(c === '"') q=true;
      else if(c === ','){ row.push(cur); cur=""; }
      else if(c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; }
      else if(c !== '\r'){ cur+=c; }
    }
  }
  row.push(cur); rows.push(row);
  return rows.filter(r => r.some(x => (x||"").trim() !== ""));
}
function toObjects(table){
  const header = table[0].map(x => (x||"").trim());
  return table.slice(1).map(r=>{
    const o={};
    header.forEach((k,i)=>o[k]=r[i] ?? "");
    return o;
  });
}
function norm(s){ return (s ?? "").toString().trim(); }
function get(o, key){
  if(o[key] !== undefined) return o[key];
  const k = Object.keys(o).find(x => x.toLowerCase() === key.toLowerCase());
  return k ? o[k] : "";
}
function escapeHTML(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ---------------- Data ---------------- */
let ITEMS = [];
let VIEW  = [];
let COLS_WITH_ITEMS = new Set();
let COL_NODES = new Map();
let ACTIVE_COL = null;
let ACTIVE_KEY = null;

let SORT = { key: "Description", dir: "asc" };

function colRange(a,b){
  const out=[];
  for(let i=a.charCodeAt(0); i<=b.charCodeAt(0); i++) out.push(String.fromCharCode(i));
  return out;
}
function sortIcon(thKey){
  if(SORT.key !== thKey) return "";
  return SORT.dir === "asc" ? " ▲" : " ▼";
}

/* ---------------- Map ---------------- */
function buildMap(){
  const map = $("map");
  map.innerHTML = "";
  COL_NODES.clear();

  const westCols  = colRange("P","X");
  const southCols = colRange("J","O");
  const eastCols  = colRange("A","I");

  // SOUTH on TOP (row 1)
  const southBox = wallBox("South Wall", "J–O", southCols, "row");
  southBox.style.gridColumn = "1 / span 3";
  southBox.style.gridRow = "1";

  // EAST on LEFT (row 3)
  const eastBox = wallBox("East Wall", "A–I", eastCols, "col");
  eastBox.style.gridColumn = "1";
  eastBox.style.gridRow = "3";

  // WEST on RIGHT (row 3)
  const westBox = wallBox("West Wall", "P–X", westCols, "col");
  westBox.style.gridColumn = "3";
  westBox.style.gridRow = "3";

  // Center aisle label (rows 2-3)
  const center = document.createElement("div");
  center.className = "centerGap";
  center.innerHTML = `<div class="centerLabel">Center / Aisle</div>`;

  map.appendChild(southBox);
  map.appendChild(eastBox);
  map.appendChild(center);
  map.appendChild(westBox);
}

function wallBox(name, range, cols, mode){
  const box = document.createElement("div");
  box.className = "wallBox";

  const hd = document.createElement("div");
  hd.className = "wallHd";
  hd.innerHTML = `<div class="wallName">${name}</div><div class="wallRange">${range}</div>`;

  const grid = document.createElement("div");
  grid.className = "cols " + mode;

  cols.forEach(c=>{
    const tile = document.createElement("div");
    tile.className = "colTile" + (COLS_WITH_ITEMS.has(c) ? " has" : "");
    tile.textContent = c;
    tile.dataset.col = c;

    tile.addEventListener("click", () => {
      const q = $("search").value.trim();
      const token = `col:${c}`;
      if(!q.toLowerCase().includes(token.toLowerCase())){
        $("search").value = (q ? q + " " : "") + token;
        run();
      }
    });

    COL_NODES.set(c, tile);
    grid.appendChild(tile);
  });

  box.appendChild(hd);
  box.appendChild(grid);
  return box;
}

function setActiveColumn(c){
  if(ACTIVE_COL && COL_NODES.get(ACTIVE_COL)) COL_NODES.get(ACTIVE_COL).classList.remove("active");
  ACTIVE_COL = c;
  if(c && COL_NODES.get(c)) COL_NODES.get(c).classList.add("active");
}

/* ---------------- Directory Table ---------------- */
function parseQuery(q){
  const parts = q.split(/\s+/).filter(Boolean);
  let colFilter = null;
  const terms = [];
  for(const p of parts){
    const m = p.match(/^col:([a-z])$/i);
    if(m) colFilter = m[1].toUpperCase();
    else terms.push(p.toLowerCase());
  }
  return { colFilter, terms };
}

function computeView(){
  const q = norm($("search").value);
  const { colFilter, terms } = parseQuery(q);

  let arr = ITEMS;

  if(colFilter){
    arr = arr.filter(it => it.Column === colFilter);
    setActiveColumn(colFilter);
  } else {
    if(!ACTIVE_KEY) setActiveColumn(null);
  }

  if(terms.length){
    arr = arr.filter(it=>{
      const hay = (it.Description + " " + it.ChestID + " " + it.Categories + " " + it.Column).toLowerCase();
      return terms.every(t => hay.includes(t));
    });
  }

  const dirMul = (SORT.dir === "asc") ? 1 : -1;
  arr = arr.slice().sort((a,b)=>{
    const av = sortValue(a, SORT.key);
    const bv = sortValue(b, SORT.key);
    if(av === bv) return (a.Description||"").localeCompare(b.Description||"");
    return av.localeCompare(bv) * dirMul;
  });

  VIEW = arr;
  $("stat").textContent = `${VIEW.length} / ${ITEMS.length}`;
}

function sortValue(it, key){
  if(key === "Description") return (it.Description || "").toLowerCase();
  if(key === "Categories") return (it.Categories || "").toLowerCase();
  if(key === "ChestID") return (it.ChestID || "").toLowerCase();
  return "";
}

function renderTable(){
  const tb = $("tbody");
  tb.innerHTML = "";

  document.querySelectorAll("thead th").forEach(th=>{
    const k = th.dataset.sort;
    if(!k) return;
    const base = th.textContent.split(" ▲")[0].split(" ▼")[0].trim();
    th.textContent = base + sortIcon(k);
  });

  if(!VIEW.length){
    $("none").style.display = "block";
    return;
  }
  $("none").style.display = "none";

  VIEW.slice(0, 600).forEach(it=>{
    const key = `${it.ChestID}|||${it.Description}`;
    const tr = document.createElement("tr");
    if(ACTIVE_KEY === key) tr.classList.add("selected");
    tr.addEventListener("click", () => selectItem(it));

    tr.innerHTML = `
      <td>${escapeHTML(it.Description)}</td>
      <td class="mono">${escapeHTML(it.ChestID || "—")}</td>
      <td><span class="pill">${escapeHTML(it.Categories || "—")}</span></td>
    `;
    tb.appendChild(tr);
  });

  if(VIEW.length > 600){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="3" class="muted" style="padding:10px">Showing first 600 rows — refine your search.</td>`;
    tb.appendChild(tr);
  }
}

function selectItem(it){
  ACTIVE_KEY = `${it.ChestID}|||${it.Description}`;
  setActiveColumn(it.Column);

  $("selDesc").textContent = it.Description || "—";
  $("selChest").textContent = it.ChestID || "—";
  $("selCol").textContent = it.Column || "—";

  renderTable();
}

function run(){
  computeView();
  renderTable();
}

/* ---------------- Load ---------------- */
function loadCSV(text){
  const t = parseCSV(text);
  if(!t.length || t.length < 2) throw new Error("CSV seems empty or missing a header row.");

  const o = toObjects(t);

  ITEMS = o.map(x => ({
    ChestID: norm(get(x, "ChestID")),
    Column:  norm(get(x, "Column")).toUpperCase(),
    Description: norm(get(x, "Description")),
    Categories: norm(get(x, "Categories")),
  }))
  .filter(x => x.Column && x.Description);

  COLS_WITH_ITEMS = new Set(ITEMS.map(x => x.Column));

  buildMap();
  ACTIVE_KEY = null;
  setActiveColumn(null);

  SORT = { key: "Description", dir: "asc" };

  run();
  if(VIEW[0]) selectItem(VIEW[0]);
}

async function loadFromServer(){
  $("message").style.display = "none";
  try{
    const res = await fetch("items.csv", { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    loadCSV(await res.text());
    $("localFallback").style.display = "none";
  }catch(err){
    $("message").innerHTML = `<div class="notice">Server load failed. Local CSV mode enabled.</div>`;
    $("message").style.display = "block";
    $("localFallback").style.display = "block";
    $("stat").textContent = "Waiting for CSV";
    COLS_WITH_ITEMS = new Set();
    buildMap();
  }
}

/* ---------------- Events ---------------- */
$("search").addEventListener("input", () => run());
$("clear").addEventListener("click", () => { $("search").value=""; run(); });

document.querySelectorAll("thead th").forEach(th=>{
  th.addEventListener("click", () => {
    const key = th.dataset.sort;
    if(!key) return;

    if(SORT.key === key){
      SORT.dir = (SORT.dir === "asc") ? "desc" : "asc";
    }else{
      SORT.key = key;
      SORT.dir = "asc";
    }
    run();
  });
});

$("loadFile").addEventListener("click", async()=>{
  const f = $("file").files[0];
  if(!f) return;
  try{
    loadCSV(await f.text());
    $("message").style.display = "none";
  }catch(e){
    $("message").innerHTML = `<div class="error">Could not parse CSV: ${escapeHTML(e.message)}</div>`;
    $("message").style.display = "block";
  }
});

/* boot */
loadFromServer();
</script>
</body>
</html>
