<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Storage Directory</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101826; --text:#e6edf3; --muted:#9fb0c0; --border:#223042;
      --accent:#7aa2ff; --ok:#46d39a;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:var(--sans);
      padding:18px;
    }
    header{
      max-width:1200px; margin:0 auto 14px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; }
    .topControls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"]{
      min-width:320px; max-width:520px; width:min(520px, 88vw);
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);
      outline:none;
    }
    input[type="text"]:focus{ border-color:rgba(122,162,255,.6); box-shadow:0 0 0 3px rgba(122,162,255,.15) }
    button{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--text);
      cursor:pointer; font-weight:700;
    }
    button:hover{ background:rgba(255,255,255,.06) }

    main{
      max-width:1200px; margin:0 auto;
      display:grid; grid-template-columns: 420px 1fr; gap:14px;
    }
    @media (max-width: 980px){ main{ grid-template-columns: 1fr; } }

    .panel{
      border:1px solid var(--border); border-radius:var(--radius);
      background:linear-gradient(to bottom, rgba(16,24,38,.78), rgba(16,24,38,.55));
      box-shadow:var(--shadow); overflow:hidden;
    }
    .hd{
      padding:12px 14px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .hd .k{ color:var(--muted); font-size:12px; letter-spacing:.35px; text-transform:uppercase; }
    .bd{ padding:12px 14px; }

    .stat{ color:var(--muted); font-size:12px; font-family:var(--mono); }

    .results{ display:flex; flex-direction:column; gap:10px; }
    .card{
      border:1px solid var(--border); border-radius:12px;
      padding:10px 10px; background:rgba(255,255,255,.02);
      cursor:pointer;
      transition: border-color .12s ease, background .12s ease;
    }
    .card:hover{ border-color:rgba(122,162,255,.35); background:rgba(255,255,255,.04); }
    .card .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:6px;
    }
    .id{ font-family:var(--mono); font-weight:800; font-size:12px; }
    .pill{
      font-family:var(--mono); font-size:11px; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(70,211,154,.35); color:var(--ok); background:rgba(70,211,154,.08);
      white-space:nowrap;
    }
    .desc{ font-size:12.5px; line-height:1.25; }
    .meta{ margin-top:6px; color:var(--muted); font-size:11px; display:flex; gap:10px; flex-wrap:wrap; }
    .muted{ color:var(--muted); }
    .mono{ font-family:var(--mono); }

    /* Diagram */
    .diagramWrap{ display:flex; flex-direction:column; gap:12px; }
    .diagram{
      border:1px solid var(--border); border-radius:var(--radius);
      background:rgba(255,255,255,.02); padding:12px;
      overflow:auto;
    }
    .legend{ color:var(--muted); font-size:12px; line-height:1.35; }
    .layout{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      min-width: 640px;
    }
    .wallBox{
      border:1px solid var(--border); border-radius:14px; overflow:hidden;
      background:rgba(255,255,255,.02);
    }
    .wallHd{
      padding:10px 12px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .wallName{ font-weight:900; }
    .wallRange{ color:var(--muted); font-family:var(--mono); font-size:12px; }
    .cols{
      display:grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(52px, 1fr);
      gap:8px;
      padding:10px;
    }
    .colTile{
      border:1px solid var(--border); border-radius:12px;
      background:rgba(255,255,255,.02);
      padding:10px 6px;
      display:flex; align-items:center; justify-content:center;
      font-family:var(--mono); font-weight:900;
      color:var(--muted);
      user-select:none;
      position:relative;
      min-height:44px;
    }
    .colTile.active{
      border-color: rgba(122,162,255,.9);
      box-shadow: 0 0 0 4px rgba(122,162,255,.18);
      background: rgba(122,162,255,.10);
      color: var(--text);
    }
    .colTile .dot{
      position:absolute; top:7px; right:7px;
      width:8px; height:8px; border-radius:999px;
      background: rgba(70,211,154,.85);
      box-shadow: 0 0 0 3px rgba(70,211,154,.14);
      opacity:.0;
    }
    .colTile.hasItems .dot{ opacity:1; }

    .details{
      border-top:1px solid var(--border);
      padding:12px 14px;
      background:rgba(16,24,38,.35);
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .details .blk .k{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.35px; }
    .details .blk .v{ font-family:var(--mono); font-size:12px; margin-top:4px; }

    .error{
      padding:10px 12px;
      border:1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.08);
      border-radius:12px;
      color: var(--text);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Storage Directory</h1>
    <div class="sub">Search items, then see which wall/column to go to (A–X).</div>
  </div>
  <div class="topControls">
    <input id="q" type="text" placeholder="Search (e.g., prismarine, quartz, B2-7, torches)..." />
    <button id="clear">Clear</button>
    <button id="reload">Reload items2.csv</button>
  </div>
</header>

<main>
  <!-- Directory -->
  <section class="panel">
    <div class="hd">
      <div class="k">Directory</div>
      <div class="stat" id="stat">Loading…</div>
    </div>
    <div class="bd">
      <div id="err" style="display:none;"></div>
      <div class="results" id="results"></div>
      <div class="muted" id="none" style="display:none; font-size:12px; padding:8px 2px;">
        No matches.
      </div>
    </div>
  </section>

  <!-- Diagram -->
  <section class="panel">
    <div class="hd">
      <div class="k">Where are the columns?</div>
      <div class="stat mono">East: A–I • South: J–O • West: P–X</div>
    </div>
    <div class="bd diagramWrap">
      <div class="legend">
        The green dot means that column has at least one defined chest entry in <span class="mono">itesm2.csv</span>.
        Click a search result to highlight its column.
      </div>

      <div class="diagram">
        <div class="layout" id="layout"></div>
      </div>

      <div class="details">
        <div class="blk">
          <div class="k">Selected</div>
          <div class="v" id="selDesc">—</div>
        </div>
        <div class="blk">
          <div class="k">ChestID</div>
          <div class="v" id="selChest">—</div>
        </div>
        <div class="blk">
          <div class="k">Wall / Column</div>
          <div class="v" id="selLoc">—</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const $ = (id) => document.getElementById(id);

  /** CSV parser (handles quotes) **/
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (inQuotes){
        if (ch === '"' && next === '"'){ cur += '"'; i++; }
        else if (ch === '"'){ inQuotes = false; }
        else cur += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ','){ row.push(cur); cur = ""; }
        else if (ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; }
        else if (ch === '\r'){ /* ignore */ }
        else cur += ch;
      }
    }
    row.push(cur); rows.push(row);
    while (rows.length && rows[rows.length-1].every(c => (c??"").toString().trim()==="")) rows.pop();
    return rows;
  }

  function normalize(s){ return (s ?? "").toString().trim(); }

  function rowsToObjects(table){
    const header = table[0].map(h => normalize(h));
    const objs = [];
    for (let r=1; r<table.length; r++){
      const arr = table[r];
      if (arr.every(c => normalize(c)==="")) continue;
      const o = {};
      for (let c=0; c<header.length; c++){
        o[header[c] || ("Col"+c)] = arr[c] ?? "";
      }
      objs.push(o);
    }
    return objs;
  }

  function getField(o, ...names){
    for (const n of names){
      if (o[n] !== undefined) return o[n];
      const key = Object.keys(o).find(k => k.toLowerCase() === n.toLowerCase());
      if (key) return o[key];
    }
    return "";
  }

  function wallForColumn(col){
    const c = col.toUpperCase();
    if (c >= "A" && c <= "I") return "East";
    if (c >= "J" && c <= "O") return "South";
    if (c >= "P" && c <= "X") return "West";
    return "Other";
  }

  function colRange(start, end){
    const out = [];
    for (let i=start.charCodeAt(0); i<=end.charCodeAt(0); i++){
      out.push(String.fromCharCode(i));
    }
    return out;
  }

  /** Data **/
  let ITEMS = [];      // {ChestID, Column, Description}
  let COL_HAS_ITEMS = new Set();
  let COL_TILES = new Map(); // "A" -> element
  let ACTIVE_COL = null;

  /** UI **/
  function buildDiagram(){
    const layout = $("layout");
    layout.innerHTML = "";
    COL_TILES.clear();

    const walls = [
      { name: "East Wall",  range: "A–I", cols: colRange("A","I") },
      { name: "South Wall", range: "J–O", cols: colRange("J","O") },
      { name: "West Wall",  range: "P–X", cols: colRange("P","X") },
    ];

    for (const w of walls){
      const box = document.createElement("div");
      box.className = "wallBox";

      const hd = document.createElement("div");
      hd.className = "wallHd";
      hd.innerHTML = `<div class="wallName">${w.name}</div><div class="wallRange">${w.range}</div>`;

      const cols = document.createElement("div");
      cols.className = "cols";

      for (const c of w.cols){
        const tile = document.createElement("div");
        tile.className = "colTile";
        tile.dataset.col = c;
        tile.textContent = c;

        const dot = document.createElement("div");
        dot.className = "dot";
        tile.appendChild(dot);

        if (COL_HAS_ITEMS.has(c)) tile.classList.add("hasItems");

        tile.addEventListener("click", () => {
          // Clicking column filters search to that column (nice shortcut)
          const q = $("q").value.trim();
          if (!q.toLowerCase().includes(`col:${c.toLowerCase()}`)){
            $("q").value = (q ? q + " " : "") + `col:${c}`;
            runSearch();
          }
        });

        COL_TILES.set(c, tile);
        cols.appendChild(tile);
      }

      box.appendChild(hd);
      box.appendChild(cols);
      layout.appendChild(box);
    }
  }

  function setActiveColumn(col){
    if (ACTIVE_COL && COL_TILES.get(ACTIVE_COL)) COL_TILES.get(ACTIVE_COL).classList.remove("active");
    ACTIVE_COL = col;
    if (col && COL_TILES.get(col)) COL_TILES.get(col).classList.add("active");
  }

  function renderResults(list){
    const results = $("results");
    results.innerHTML = "";

    if (!list.length){
      $("none").style.display = "block";
      return;
    }
    $("none").style.display = "none";

    // Sort by Description, then ChestID
    list.sort((a,b) => {
      const ad = a.Description.toLowerCase(), bd = b.Description.toLowerCase();
      if (ad !== bd) return ad.localeCompare(bd);
      return a.ChestID.localeCompare(b.ChestID);
    });

    // cap
    const shown = list.slice(0, 200);
    for (const it of shown){
      const card = document.createElement("div");
      card.className = "card";
      card.addEventListener("click", () => selectItem(it));

      const top = document.createElement("div");
      top.className = "top";
      top.innerHTML = `<div class="id">${it.ChestID || "—"}</div><div class="pill">${wallForColumn(it.Column)} / ${it.Column}</div>`;

      const desc = document.createElement("div");
      desc.className = "desc";
      desc.textContent = it.Description || "(no description)";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<span class="mono">Column ${it.Column}</span>`;

      card.appendChild(top);
      card.appendChild(desc);
      card.appendChild(meta);
      results.appendChild(card);
    }

    if (list.length > 200){
      const more = document.createElement("div");
      more.className = "muted";
      more.style.fontSize = "12px";
      more.style.padding = "8px 2px 0";
      more.textContent = `Showing first 200 results — refine your search.`;
      results.appendChild(more);
    }
  }

  function selectItem(it){
    setActiveColumn(it.Column);

    $("selDesc").textContent = it.Description || "—";
    $("selChest").textContent = it.ChestID || "—";
    $("selLoc").textContent = `${wallForColumn(it.Column)} / Column ${it.Column}`;
  }

  function parseQuery(q){
    // Supports optional token: col:A (filters to Column A)
    // Everything else is normal substring search over Description + ChestID
    const parts = q.split(/\s+/).filter(Boolean);
    let colFilter = null;
    const terms = [];

    for (const p of parts){
      const m = p.match(/^col:([a-z])$/i);
      if (m) colFilter = m[1].toUpperCase();
      else terms.push(p.toLowerCase());
    }
    return { colFilter, terms };
  }

  function runSearch(){
    const q = normalize($("q").value);
    const { colFilter, terms } = parseQuery(q);

    let filtered = ITEMS;

    if (colFilter){
      filtered = filtered.filter(it => it.Column === colFilter);
      setActiveColumn(colFilter);
    } else {
      setActiveColumn(null);
    }

    if (terms.length){
      filtered = filtered.filter(it => {
        const hay = (it.Description + " " + it.ChestID + " " + it.Column).toLowerCase();
        return terms.every(t => hay.includes(t));
      });
    }

    $("stat").textContent = `${filtered.length} match(es) • ${ITEMS.length} total`;
    renderResults(filtered);
  }

  function showError(msg){
    const err = $("err");
    err.style.display = "block";
    err.className = "error";
    err.textContent = msg;
  }

  async function loadCSV(){
    $("err").style.display = "none";
    $("stat").textContent = "Loading…";

    let text;
    try{
      const res = await fetch("itesm2.csv", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      text = await res.text();
    }catch(e){
      showError(
        `Couldn't load itesm2.csv.\n\n` +
        `Make sure this HTML file and itesm2.csv are in the SAME directory on a web server.\n` +
        `Error: ${e.message}`
      );
      $("stat").textContent = "Load failed";
      return;
    }

    const table = parseCSV(text);
    if (!table.length || table.length < 2){
      showError("itesm2.csv loaded, but it looks empty (or missing a header row).");
      $("stat").textContent = "0 loaded";
      return;
    }

    const objs = rowsToObjects(table);

    ITEMS = objs.map(o => {
      const chest = normalize(getField(o, "ChestID"));
      const col   = normalize(getField(o, "Column")).toUpperCase();
      const desc  = normalize(getField(o, "Description"));
      return { ChestID: chest, Column: col, Description: desc };
    }).filter(x => x.Column && x.Description); // directory entries: must have a column + description

    // Mark which columns have entries
    COL_HAS_ITEMS = new Set(ITEMS.map(it => it.Column));

    buildDiagram();
    $("stat").textContent = `${ITEMS.length} total`;
    runSearch();

    // Auto-select first item so the diagram shows something
    if (ITEMS[0]) selectItem(ITEMS[0]);
  }

  $("q").addEventListener("input", runSearch);
  $("clear").addEventListener("click", () => { $("q").value=""; setActiveColumn(null); runSearch(); });
  $("reload").addEventListener("click", loadCSV);

  // boot
  loadCSV();
</script>
</body>
</html>
